# ChatServlet
Чат-комната на основе технологии сервлетов.
Сами сервлеты мне не интересны, и тратить время на чтение специальной литературы мне тоже не хотелось,
поэтому приложение собиралось "по кусочкам" из разных интернет источников.
Некторые вещи, вне сомнений, реализованы профански и неверно, и будут исправляться мной при необходимости.
Это лабораторная по _Компьютерным системам_, так что я не сильно старался.

Приложение состоит из двух страниц. Первая страница входа/регистрации:

![Imgur](https://i.imgur.com/BwLgnbm.png)

Вторая страница, собственно, сам чат:

![Imgur](https://i.imgur.com/RSbqg7c.png)

Клиент для общения с сервером исользует технологию __AJAX__, отправляя единственному сервлету _ChatServlet_
_POST_ и _GET_ запросы. После обработки запроса сервер возвращет _JSON-строку_. Для обращения к определенным
методам _API_ используют аттбирбут `action`. В целом запрос к серверу выглядит следующим образом:
`ChatServlet?action=имя_метода`.

В случае успешного запроса, ответ сервера будет следующего вида:

```
{
  "response": JSONObject|JSONArray
}
```

Иначе:

```
{
  "error": {
    "error_code": code,
    "error_msg": "Сообщение"
  }
}
```

На данном этапе известны следующие коды ошибок:

- 1 – неизвестный метод
- 2 – не удалось войти в аккаунт (неверный пароль)
- 3 – нет прав доступа
- 4 – отсутствует обязательный параметр
- 100 – неизвестная ошибка сервера

На данный момент сервер поддерживает следующие методы:

<table>
<thead>
<tr>
<th>Метод</th>
<th>Тип запроса</th>
<th>Параметры</th>
<th>Коды ошибок</th>
<th>Ответ</th>
</tr>
</thead>

<tbody>

<tr>
<td>register</td>
<td>POST</td>
<td>login, password</td>
<td>2, 4</td>
<td>
<pre lang="json">
{
  "url": "chat.jsp"
}
</pre>
</td>
</tr>

<tr>
<td>logout</td>
<td>GET</td>
<td></td>
<td></td>
<td>
Уничтожает сессию и перебрасывает на страницу регистрации.
</td>
</tr>

<tr>
<td>sendMessage</td>
<td>POST</td>
<td>message</td>
<td>3, 4</td>
<td>
Message:
<pre lang="json">
{
  "user": "Логин пользователя",
  "message": "Сообщение",
  "time": long (в мс)
}
</pre>
</td>
</tr>

<tr>
<td>getMessages</td>
<td>GET</td>
<td></td>
<td>3, 4</td>
<td>
<pre lang="json">
JSONArray of Message
</pre>
</td>
</tr>

<tr>
<td>cometMessage</td>
<td>GET</td>
<td></td>
<td>3</td>
<td>
Используется технология <b>COMET</b>. Клиент ждет ответа сервера.
Как только пришло новое сообщение, оно возвращается клиенту,
а ему необходимо заново подключиться к серверу.
Метод возвращает новый
<code>Message</code>.

</td>
</tr>

</tbody>
</table>

У текущей реализации программы множество недочетов.
Вот их перечень:

- при неудачной регистрации `timeout'ы` сбивают друг друга
- при получении нового сообщения чат прокрутится вниз до него, даже
если пользователь просматривает предыдущие сообщения
- __COMET__ передает одно сообщение за раз, пользователь может
пропустить некоторые сообщения
- `getMessages` возвращает все сообщения, что может быть очень долго
и не нужно
- методы `getMessages` и `cometMessage` необходимо объединить в один
- нужно добавить сообщения о входе/выходе пользователя из чата
- `timeout` при __COMET__ бесконечный, это не очень хорошо
- сделать мобильную верстку
- сообщения хранятся в оперативной памяти, а не базе данных

По мере желания, эти недочеты будут исправляться.